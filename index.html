<html>
<head>
 <meta charset="utf-8">
 <meta name="viewport" content="width=device-width, initial-scale=1">
 <title>Table Firebase</title>
 <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css">
 <script defer src="https://use.fontawesome.com/releases/v5.0.0/js/all.js"></script>
 <!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">

<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap-theme.min.css" integrity="sha384-6pzBo3FDv/PJ8r2KRkGHifhEocL+1X2rVCTTkUfGk7/0pbek5mMa1upzvWbrUbOZ" crossorigin="anonymous">
</head>
<body>
 <section class="section">
 <div class="container">
 <h1 class="title text-center">
 Табличка Firebase
 </h1>
 <div class="content">
  <div class="row" style="display:flex;">
       <div class="form-group">
                    <select class  ="form-control" name="state" id="maxRows">
                         <option value="5000">Show ALL Rows</option>
                         <option value="5">5</option>
                         <option value="10">10</option>
                         <option value="15">15</option>
                         <option value="20">20</option>
                         <option value="50">50</option>
                         <option value="70">70</option>
                         <option value="100">100</option>
                        </select>
                </div>
        <div class="addbtn">
            <button id="btnAdd" class="btn btn-primary" style="margin-left: 10%"><i class="fa fa-plus"></i>Добавить контакт</button>
        </div>
  </div>
          <div class="row">
          <div class="panel panel-primary">
          <div class="panel-heading">
            <h4 class="panel-title" style="margin-top:4px">Контакты</h4>
            <div class="pull-right">
              <span class="clickable filter" data-toggle="tooltip" title="Открыть фильтр" data-container="body">
                <i class="glyphicon glyphicon-filter" style="margin-top:-6px">Фильтр</i>
              </span>
            </div>
          </div>
          <div class="panel-body">
            <input type="text" class="form-control" id="dev-table-filter" data-action="filter" data-filters="#table-id" placeholder="Фильтр" />
          </div>
    <table class="order-table table" id="table-id">
  <thead class="thead-dark" id="table">
      <tr>
        <th scope="col">Имя:</th>
        <th scope="col">Email:</th> 
        <th scope="col">Телефон:</th>
        <th scope="col"></th>
        <th scope="col"></th>
      </tr>
    </thead>
      <tbody id="card-list">
      </tbody>
    </table>
            <div class='pagination-container text-center' >
                <nav>
                  <ul class="pagination">
                        <li data-page="prev" ><span> < <span class="sr-only">(current)</span></span></li>
                        <li data-page="next" id="prev"><span> > <span class="sr-only">(current)</span></span></li>
                  </ul>
                </nav>
            </div>

</div>
    
 </div>
 </div>
 </div>
 <div id="modal" class="modal">
 <div class="modal-background"></div>
 <div class="modal-card">
 <header class="modal-card-head">
 <p class="modal-card-title">Контакт</p>
 <button class="btnClose delete" aria-label="close"></button>
 </header>
 <section class="modal-card-body">
 <div class="field">
 <label class="label">Имя</label>
 <div class="control">
 <input type="hidden" id="txtType">
 <input type="hidden" id="txtKey">
 <input class="input" id="txtName" type="text" placeholder="Имя">
 </div>
 <p class="help"> </p>
 </div>
 <div class="field">
 <label class="label">Email</label>
 <div class="control">
 <input class="input" id="txtEmail" type="text" placeholder="Email">
 </div>
 <p class="help"> </p>
 </div>
 <div class="field">
 <label class="label">Телефон</label>
 <div class="control">
 <input class="input" id="txtPic" type="text" placeholder="Телефон">
 </div>
 <p class="help"></p>
 </div>
 </section>
 <footer class="modal-card-foot">
 <button id="btnSave" class="button is-success">Сохранить</button>
 <button id="btnClose" class="button">Выход</button>
 </footer>
 </div>
 </div>
 </section>

 <style>
.pagination li:hover{
    cursor: pointer;
}
.clickable{
    cursor: pointer;   
}
.panel-heading div {
    margin-top: -18px;
    font-size: 15px;
}
.panel-heading div span{
  margin-left:5px;
}
.panel-body{
  display: none;
}
  @keyframes ring {
  5% {
    transform: translateX(-1px);
  }
  
  10% {
    transform: translateX(2px);
  }

  15% {
    transform: translateX(-4px);
  }

  20% {
    transform: translateX(4px);
  }
    
    21%, 100% {
        transform: translateX(0);
    }
}
.filter i {
    animation: ring 1s cubic-bezier(.36,.07,.19,.97) infinite;
    display: block;
    display: block;
}
 </style>
 <script src="https://code.jquery.com/jquery-2.2.4.min.js"
 integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
 crossorigin="anonymous"></script>
 <script src="https://www.gstatic.com/firebasejs/4.10.0/firebase.js"></script>
 <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
 <script src="https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>
 <script>
 var nextkey =0;
 var firebaseConfig = {
    apiKey: "AIzaSyBSWFK3i8tp6PwX0TVMPK8613yuqqJZhWc",
    authDomain: "datatable-54557.firebaseapp.com",
    databaseURL: "https://datatable-54557.firebaseio.com",
    projectId: "datatable-54557",
    storageBucket: "datatable-54557.appspot.com",
    messagingSenderId: "1013895628287",
    appId: "1:1013895628287:web:a24c3f4371234ece"
  };
  // Initialize Firebase
  firebase.initializeApp(firebaseConfig);

 var database = firebase.database();
 database.ref('users').on('child_added', function(data) {
 add_data_table(data.val().username,data.val().email,data.val().pic,data.key);
 var lastkey = data.key;
 nextkey = parseInt(lastkey)+1;
 });
 database.ref('users').on('child_changed', function(data) {
 update_data_table(data.val().username,data.val().email,data.val().pic,data.key)
 });
 database.ref('users').on('child_removed', function(data) {
 remove_data_table(data.key)
 });
 
 function add_data_table(name,email,pic,key){
 $("#card-list").append('<tr class="key" id="'+key+'"><td><div class="book-pic">'+name+'</div></td><td><div class="name">'+email+'</div></td><td><div class="book">'+pic+'</div></td><td width="2%"><button class="btn btn-default"><a href="#" data-key="'+key+'" class="btnEdit">&#9997</a></button></td><td width="2%"><button class="btn btn-default"><a href="#" class="btnRemove"  data-key="'+key+'">&#128465</a></button></td></div></tr></tr>');
 getPagination('#table-id');

 }
 function update_data_table(name,email,pic,key){
$("#card-list #"+key).html('<td><div class="book-pic">'+name+'</div></td><td><div class="name">'+email+'</div></td><td><div class="book">'+pic+'</div></td><td><button><a href="#" data-key="'+key+'" class="btnEdit">&#9997</a></button></td><td><button><a href="#" class="card-footer-item btnRemove"  data-key="'+key+'">&#128465</a></button></td>');
 getPagination('#table-id');
 }
 function remove_data_table(key){
$("#card-list #"+key).remove();
 getPagination('#table-id');
 }
 function new_data(name,email,pic,key){
 database.ref('users/' + key).set({
 username: name,
 email: email,
 pic: pic
 });
 }
 function update_data(name,email,pic,key){
 database.ref('users/' + key).update({
 username: name,
 email: email,
 pic: pic
 });
 }
 $( "#btnAdd" ).click(function() {
 $("#txtName").val("");
 $("#txtEmail").val("");
 $("#txtPic").val("");
 $("#txtType").val("N");
 $("#txtKey").val("0");
 $( "#modal" ).addClass( "is-active" );
 
 });
 $("#btnSave" ).click(function() {
 if($("#txtType").val() == 'N'){
 database.ref('users').once("value").then(function(snapshot) {
 if(snapshot.numChildren()==0){
 nextkey = 1;
 }
 new_data($("#txtName").val(),$("#txtEmail").val(),$("#txtPic").val(),nextkey);
 });
 }else{
 update_data($("#txtName").val(),$("#txtEmail").val(),$("#txtPic").val(),$("#txtKey").val());
 }
 $("#btnClose").click();
 });
 $(document).on("click",".btnEdit",function(event){
 event.preventDefault();
 key = $(this).attr("data-key");
 database.ref('users/'+key).once("value").then(function(snapshot){
 $("#txtName").val(snapshot.val().username);
 $("#txtEmail").val(snapshot.val().email);
 $("#txtPic").val(snapshot.val().pic); 
 $("#txtType").val("E"); 
 $("#txtKey").val(key); 
 });
 $( "#modal" ).addClass( "is-active" );
 });
 
 $(document).on("click",".btnRemove",function(event){
 event.preventDefault();
 key = $(this).attr("data-key");
 database.ref('users/' + key).remove();
 })
 
 $( "#btnClose,.btnClose" ).click(function() {
 $( "#modal" ).removeClass( "is-active" );
 });

    function getPagination (table){

    var lastPage = 1 ; 

          $('#maxRows').on('change',function(evt){
            //$('.paginationprev').html('');                       

        lastPage = 1 ; 
         $('.pagination').find("li").slice(1, -1).remove();
            var trnum = 0 ;                                 
            var maxRows = parseInt($(this).val());          

            if(maxRows == 5000 ){

                $('.pagination').hide();
            }else {
                
                $('.pagination').show();
            }

            var totalRows = $(table+' tbody tr').length;        
             $(table+' tr:gt(0)').each(function(){          
                trnum++;                                   
                if (trnum > maxRows ){                     
                    
                    $(this).hide();                         
                }if (trnum <= maxRows ){$(this).show();}
             });                                            
             if (totalRows > maxRows){                      
                var pagenum = Math.ceil(totalRows/maxRows); 
                                                            
                for (var i = 1; i <= pagenum ;){            
                $('.pagination #prev').before('<li data-page="'+i+'">\
                                      <span>'+ i++ +'<span class="sr-only">(current)</span></span>\
                                    </li>').show();
                }                                           
            }                                               
            $('.pagination [data-page="1"]').addClass('active'); 
            $('.pagination li').on('click',function(evt){       
                evt.stopImmediatePropagation();
                evt.preventDefault();
                var pageNum = $(this).attr('data-page');    

                var maxRows = parseInt($('#maxRows').val());            

                if(pageNum == "prev" ){
                    if(lastPage == 1 ){return;}
                    pageNum  = --lastPage ; 
                }
                if(pageNum == "next" ){
                    if(lastPage == ($('.pagination li').length -2) ){return;}
                    pageNum  = ++lastPage ; 
                }

                lastPage = pageNum ;
                var trIndex = 0 ;                           
                $('.pagination li').removeClass('active');   
                $('.pagination [data-page="'+lastPage+'"]').addClass('active');
                // $(this).addClass('active');                  
                 $(table+' tr:gt(0)').each(function(){      
                    trIndex++;                              
                    if (trIndex > (maxRows*pageNum) || trIndex <= ((maxRows*pageNum)-maxRows)){
                        $(this).hide();     
                    }else {$(this).show();}                 
                 });                                        
                    });                                     

        }).val(5).change();                             
    }   


$(document).ready(function(){
  $("#myInput").on("keyup", function() {
    var value = $(this).val().toLowerCase();
    $("#table-id tr").filter(function() {
      $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
    });
  });
});

(function(){
    'use strict';
  var $ = jQuery;
  $.fn.extend({
    filterTable: function(){
      return this.each(function(){
        $(this).on('keyup', function(e){
          $('.filterTable_no_results').remove();
          var $this = $(this), 
                        search = $this.val().toLowerCase(), 
                        target = $this.attr('data-filters'), 
                        $target = $(target), 
                        $rows = $target.find('tbody tr');
          if(search == '') {
            $rows.show(); 
            getPagination('#table-id');
          } else {
            $rows.each(function(){
              var $this = $(this);
              $this.text().toLowerCase().indexOf(search) === -1 ? $this.hide() : $this.show();
            })
            if($target.find('tbody tr:visible').size() === 0) {
              var col_count = $target.find('tr').first().find('td').size();
              var no_results = $('<tr class="filterTable_no_results"><td colspan="'+col_count+'">No results found</td></tr>')
              $target.find('tbody').append(no_results);
            }
             if($target.find('tbody tr:visible').size() <= $('#maxRows').val()){
              $('.pagination').hide();
            }
          }
        });
      });
    }
  });
  $('[data-action="filter"]').filterTable();
})(jQuery);

$(function(){
  $('[data-action="filter"]').filterTable();
  
  $('.container').on('click', '.panel-heading span.filter', function(e){
    var $this = $(this), 
      $panel = $this.parents('.panel');
    
    $panel.find('.panel-body').slideToggle();
    if($this.css('display') != 'none') {
      $panel.find('.panel-body input').focus();
    }
  });
  $('[data-toggle="tooltip"]').tooltip();
})

 </script>
</body>
</html>
